{% for backend in backends.values() -%}
upstream {{ backend.upstream_identifier }} {
    server {{ backend.hostname }}:{{ backend.port }};
    keepalive 8;
}

{% endfor -%}

server {
  listen [::]:80;
  server_name {{ server_name }};
  charset utf-8;
  return 301 https://{{ https_redirect }}$request_uri;
}

server {
  listen [::]:443 ssl{{ ' ' + listen_parameters if listen_parameters else '' }};
  server_name {{ server_name }};
  charset utf-8;

  client_max_body_size {{ client_max_body_size }};

  ssl_certificate {{ cert }};
  ssl_certificate_key {{ key }};
  add_header Strict-Transport-Security max-age=31536000 always;

  error_page 504 /504-{{ server_name }}.html;

  {% for extra_server_dict in extra_server_config -%}
  {% for key, value in extra_server_dict.items() -%}
  {{ key }} {{ value }};
  {% endfor -%}
  {% endfor %}

  {% if redirect -%}
  return {{ redirect }};
  {% endif %}

  {% for url, backend in backends.items() -%}
  location {{ url }} {
    proxy_pass {{ backend.protocol }}://{{ backend.upstream_identifier }};

    {% if backend.pam_auth -%}
    # Restrict access to users on this machine with PAM
    auth_pam "Restricted";
    auth_pam_service_name "nginx";

    {% endif -%}

    {% for extra_location_dict in backend.extra_location_config -%}
    {% for key, value in extra_location_dict.items() -%}
    {{ key }} {{ value }};
    {% endfor -%}
    {% endfor %}

    include proxy_params;
    include cache_params;

    proxy_set_header Host "{{ backend.upstream_hostname }}";

    proxy_ssl_trusted_certificate '{{ backend.upstream_trust_root }}';
    proxy_ssl_name {{ backend.upstream_hostname }};

    # The verification depth needed for Heroku is currently only 2, but since they might
    # change CA and certificate layout on a whim we allow a depth of 3.
    proxy_ssl_verify_depth 3;
  }

  {% endfor -%}

  {% for extra_location, block in extra_locations.items() %}
  location {{ extra_location }} {
    {{ block }}
  }
  {% endfor %}

  location = /504-{{ server_name }}.html {
    root html;
    internal;
  }
}
